<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Healthcare Test Kiosk</title>
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://cklab-edgenc01.ck-collab-engtest.com https://cdnjs.cloudflare.com http://maxcdn.bootstrapcdn.com 'unsafe-inline';" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="css/stylemaster.css">
        <link rel="stylesheet" href="css/vidplayer.css">
        <link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
        <script type="text/javascript" src="https://cklab-edgenc01.ck-collab-engtest.com/static/webrtc/js/pexrtc.js"></script>
        <script type="text/javascript" src="js/library.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script type="text/javascript">
            window.onload = function(){
        document.getElementById('register').click();
        }
    </script>
    </head>
    <body>
       <!-- Controls at top of page (Omitted)-->
       <!--input type="checkbox" id="pullDown"/>
        <div id="headerMenu">
            <p class="select"><label for="audioSource">Microphone: </label><select id="audioSource"></select></p>
            <p class="select"><label for="audioOutput">Speakers: </label><select id="audioOutput"></select></p>
            <p class="select"><label for="videoSource">Camera: </label><select id="videoSource"></select></p>
        </div>
        <label id="pullDownLabel" for="pullDown"><p>Settings</p></label-->

        <!-- GIF that plays for kiosk mode-->
        <div class="videoStage" align="center">
            <video width="98%" id="video" playsinline="playsinline" poster="img/hospital.gif" class="mediastream" muted autoplay="autoplay"/>
            </div>
            <br>
        <!-- Create the corner navigation (Omitted)-->
        <!--div class="cornerNav">
            <ul class="close">
                   <li class="icon-star"></li>
                   <li class="icon-microphone"></li>
                   <li class="icon-volume-up"></li>
                   <li class="icon-off" onclick="window.location='index.html';" id="id_disconnect"></li>
                   <div class="icon-plus-sign-alt" id="btn"></div>
               </ul>
           </div-->
        <!-- Hardcoded registration form for Pexip Client API-->
        <div class="regForm" style="display: none;">
            <form>
            <label class="clabel">Alias </label><input class="cinput" type="text" id="reg_alias" value="traumarm114@ck-collab-engtest.com" size=40 /><br/>
            <label class="clabel">Username </label><input class="cinput" type="text" id="reg_username" value="admin" size=40 /><br/>
            <label class="clabel">Password </label><input class="cinput" type="password" id="reg_password" value="R3g1stR" size=40 /><br/>
            <label class="clabel">Host </label><input class="cinput" type="text" id="reg_host" value="cklab-edgenc01.ck-collab-engtest.com" size=40 /><br/><br/>
            <input class="green cinput" id="register" type="button" onclick="reg.register()" value="Register" /><label id="regerror" class="red"></label><br/>
            </form>
        </div>
    <br><br>
        <div style="display: none;">
            <form id="joinleaveform" onsubmit="return user.join()" action="insession.html">
            <label class="clabel">Conference </label><input class="cinput" type="text" id="conference" value="" size=40 /><br/>
            <label class="clabel">Worker </label><input class="cinput" type="text" id="worker" value="" size=40 /><br/>
            <label class="clabel">Pin </label><input class="cinput" type="text" id="pin" value="" size=8 /><br/>
            <label class="clabel">Display name </label><input class="cinput" type="text" id="display_name" value="" size=40 /><br/>
            <label class="clabel">Extension </label><input class="cinput" type="text" id="two_stage_dial_ext" value="" size=40 /><br/>
            <label class="clabel">Start conference if host </label><input class="cinput" type="checkbox" id="start_if_host" /><br/><br/>
            <input class="green cinput" id="joinleave" type="submit" value="Join Conference" /><label id="joinerror" class="red"></label><br/>
            </form>
        </div>
    <br/>
    <!-- Video Controls JS --> 

    <script type="text/javascript">

        (function() {
      
        $('li').text('');
      
            var co = $('ul').find('li').each(function(){
            var $this = $(this),
                $author = $this.data('item');
            
            var author = $('<span></span>', {
            class: 'item-close',
            text: $author
            }).appendTo( $this.closest('li') );
          
        });
      
        var $close = $('.close'),
            $pop = $('.pop'),
            $iconvidon = $('.icon-star'),
            $iconvidoff = $('.icon-star-half-full'),
            $iconmicon = $('.icon-microphone'),
            $iconmicoff = $('.icon-microphone-off'),
            $iconspeakerson = $('.icon-volume-up'),
            $iconspeakersoff = $('.icon-volume-off'),
            $icontrayclose = $('.icon-resize-small'),
            $icontrayopen = $('.icon-plus-sign-alt'),
            $iconbox = $('.icon-box'),
            $itemclose = $('.item-close'),
            $button = $('#btn');
        
            $($button).on('click', function() {
                $($close, $pop).toggleClass('close pop');
                $($iconvidon, $iconvidoff).toggleClass('icon-star icon-star-half-full');
                $($iconmicon, $iconmicoff).toggleClass('icon-microphone icon-microphone-off');
                $($iconspeakerson, $iconspeakersoff).toggleClass('icon-volume-up icon-volume-off');
                $($icontrayopen, $icontrayclose).toggleClass('icon-plus-sign-alt icon-resize-small');
                $($itemclose).toggleClass('item-close item-open');
                $($button).toggleClass('active');
                
            });
        })();
        </script>
        
        <!-- Select Media Devices in Settings -->
        
        <script type="text/javascript">
        
        'use strict';
        
        const videoElement = document.querySelector('videoView');
        const audioInputSelect = document.querySelector('select#audioSource');
        const audioOutputSelect = document.querySelector('select#audioOutput');
        const videoSelect = document.querySelector('select#videoSource');
        const selectors = [audioInputSelect, audioOutputSelect, videoSelect];
        
        audioOutputSelect.disabled = !('sinkId' in HTMLMediaElement.prototype);
        
        function gotDevices(deviceInfos) {
        // Handles being called several times to update labels. Preserve values.
        const values = selectors.map(select => select.value);
        selectors.forEach(select => {
            while (select.firstChild) {
            select.removeChild(select.firstChild);
            }
        });
        for (let i = 0; i !== deviceInfos.length; ++i) {
            const deviceInfo = deviceInfos[i];
            const option = document.createElement('option');
            option.value = deviceInfo.deviceId;
            if (deviceInfo.kind === 'audioinput') {
            option.text = deviceInfo.label || `microphone ${audioInputSelect.length + 1}`;
            audioInputSelect.appendChild(option);
            } else if (deviceInfo.kind === 'audiooutput') {
            option.text = deviceInfo.label || `speaker ${audioOutputSelect.length + 1}`;
            audioOutputSelect.appendChild(option);
            } else if (deviceInfo.kind === 'videoinput') {
            option.text = deviceInfo.label || `camera ${videoSelect.length + 1}`;
            videoSelect.appendChild(option);
            } else {
            console.log('Some other kind of source/device: ', deviceInfo);
            }
        }
        selectors.forEach((select, selectorIndex) => {
            if (Array.prototype.slice.call(select.childNodes).some(n => n.value === values[selectorIndex])) {
            select.value = values[selectorIndex];
            }
        });
        }
        
        navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleError);
        
        // Attach audio output device to video element using device/sink ID.
        function attachSinkId(element, sinkId) {
        if (typeof element.sinkId !== 'undefined') {
            element.setSinkId(sinkId)
                .then(() => {
                console.log(`Success, audio output device attached: ${sinkId}`);
                })
                .catch(error => {
                let errorMessage = error;
                if (error.name === 'SecurityError') {
                    errorMessage = `You need to use HTTPS for selecting audio output device: ${error}`;
                }
                console.error(errorMessage);
                // Jump back to first output device in the list as it's the default.
                audioOutputSelect.selectedIndex = 0;
                });
        } else {
            console.warn('Browser does not support output device selection.');
        }
        }
        
        function changeAudioDestination() {
        const audioDestination = audioOutputSelect.value;
        attachSinkId(videoElement, audioDestination);
        }
        
        function gotStream(stream) {
        window.stream = stream; // make stream available to console
        videoElement.srcObject = stream;
        // Refresh button list in case labels have become available
        return navigator.mediaDevices.enumerateDevices();
        }
        
        function handleError(error) {
        console.log('navigator.MediaDevices.getUserMedia error: ', error.message, error.name);
        }
        
        function start() {
        if (window.stream) {
            window.stream.getTracks().forEach(track => {
            track.stop();
            });
        }
        const audioSource = audioInputSelect.value;
        const videoSource = videoSelect.value;
        const constraints = {
            audio: {deviceId: audioSource ? {exact: audioSource} : undefined},
            video: {deviceId: videoSource ? {exact: videoSource} : undefined}
        };
        navigator.mediaDevices.getUserMedia(constraints).then(gotStream).then(gotDevices).catch(handleError);
        }
        
        audioInputSelect.onchange = start;
        audioOutputSelect.onchange = changeAudioDestination;
        
        videoSelect.onchange = start;
        
        start();
        
    </script>
    </body>
</html>
